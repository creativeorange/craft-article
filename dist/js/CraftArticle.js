/*! For license information please see CraftArticle.js.LICENSE.txt */
ArticleEditor.add("plugin","craft-image-editor",{assetId:null,start:function(){this.app.toolbar.add("craft-image-editor",{title:"Edit Image",command:"craft-image-editor.open",icon:'<span class="arx-popup-item-icon arx-icon-edit"></span>',blocks:{types:["image"]}})},open:function(){var t=this.app.block.get().getImage().nodes[0].src.match(/(.*)#asset:(\d+)(:transform:(.*))?/i);if(t){this.assetId=t[2];var e={allowSavingAsNew:!1,onSave:this.reloadImage.bind(this),allowDegreeFractions:Craft.isImagick};new Craft.AssetImageEditor(this.assetId,e)}else alert("Could not open Image Editor: asset ID is missing")},reloadImage:function(){var t=this.app.block.get().getImage(),e=function(t){var e=t.src.match(/(.*)#asset:(\d+)(:transform:(.*))?/i);if(e&&e[2]==this.assetId)if(e[4]){var s={assetId:e[2],handle:e[4]};Craft.postActionRequest("assets/generate-transform",s,(function(s){t.src=s.url+"?"+(new Date).getTime()+"#asset:"+e[2]+":transform:"+e[4]}))}else t.src=e[1]+"?"+(new Date).getTime()+"#asset:"+e[2]}.bind(this);for(var s in t.nodes)e(s=t.nodes[s])}}),ArticleEditor.add("plugin","craft-image",{volumes:null,transforms:[],defaultTransform:"",elementSiteId:null,allowAllFiles:!1,subscribe:{"popup.open":function(){var t=this.app.popup.getStack(),e=t.getName();-1!==["image-edit"].indexOf(e)&&this._build(t)}},init:function(){var t=this.opts.craft;this.volumes=t.volumes,this.transforms=t.transforms,this.defaultTransform=t.defaultTransform,this.elementSiteId=t.elementSiteId,this.allowAllFiles=t.allowAllUploaders},start:function(){this.app.addbar.add("craft-image",{title:"Image",icon:'<span class="arx-popup-item-icon arx-icon-image"></span>',command:"craft-image.showModal"})},showModal:function(t){if(void 0===this.assetSelectionModal){var e={siteId:this.elementSiteId,kind:"image"};this.allowAllFiles&&(e.uploaderId=null),this.assetSelectionModal=Craft.createElementSelectorModal("craft\\elements\\Asset",{storageKey:"CraftArticle.ChooseImage",multiSelect:!0,sources:this.volumes,criteria:e,onSelect:function(t,e){var s={},a=function(t,i){var r=t.pop(),n=this._isTransformUrl(r.url);n||0==this.defaultTransform.length?(s["asset"+r.id]={url:this._buildAssetUrl(r.id,r.url,n?e:this.defaultTransform),id:r.id},t.length?a(t,i):i()):this._getTransformUrl(r.id,this.defaultTransform,function(e){s["asset"+r.id]={url:this._buildAssetUrl(r.id,e,this.defaultTransform),id:r.id},t.length?a(t,i):i()}.bind(this))}.bind(this);a(t,function(){this.app.image.insert(s)}.bind(this))}.bind(this),transforms:this.transforms,closeOtherModals:!1})}else this.assetSelectionModal.show()},_build:function(t){var e=t.getFormItem("link"),s=this.dom("<div>").addClass(this.prefix+"-form-item");$label=this.dom("<label>").addClass(this.prefix+"-form-label").html(this.lang.parse("Transform")),s.append($label),this.$select=this._create(),s.append(this.$select),e.after(s)},_change:function(t){var e=this.dom(t.target).val(),s=this.app.block.get().getImage();this._setAssetUrl(s.nodes[0],e)},_create:function(){var t=this.transforms,e=this.dom("<select>").addClass(this.prefix+"-form-select");e.on("change",this._change.bind(this));var s=this.app.block.get().getImage(),a=this._getTransformName(s.nodes[0].src);(r=this.dom("<option>")).val(""),r.html(this.lang.parse("No Transform")),""==a&&r.attr("selected","selected"),e.append(r);for(var i=0;i<t.length;i++){var r,n=t[i];(r=this.dom("<option>")).val(n.handle),r.html(n.name),a==n.handle&&r.attr("selected","selected"),e.append(r)}return e},_isTransformUrl:function(t){return/(.*)(_[a-z0-9+].*\/)(.*)/.test(t)},_removeTransformFromUrl:function(t){return t.replace(/(.*)(_[a-z0-9+].*\/)(.*)/,"$1$3")},_buildAssetUrl:function(t,e,s){return e+"#asset:"+t+":"+(s?"transform:"+s:"url")},_getTransformName:function(t){var e=t.match(/(.*)#asset:(\d+)(:transform:(.*))?/i);return e[4]?e[4]:""},_getTransformUrl:function(t,e,s){var a={assetId:t,handle:e};Craft.postActionRequest("assets/generate-transform",a,(function(t,e){"success"===e&&(t.url?s(t.url):alert("There was an error generating the transform URL."))}))},_setAssetUrl:function(t,e){var s=this.app.block.get(),a=t.src.match(/(.*)#asset:(\d+)(:transform:(.*))?/i);if(a)if(""==e)url=this._buildAssetUrl(a[2],this._removeTransformFromUrl(a[1]),null),s.setImage({url});else{var i={assetId:a[2],handle:e};Craft.postActionRequest("assets/generate-transform",i,(function(t){s.setImage({url:t.url+"?"+(new Date).getTime()+"#asset:"+a[2]+":transform:"+e})}))}}}),ArticleEditor.add("plugin","craft-link",{linkOptions:null,elementSiteId:null,urlToSet:null,subscribe:{"popup.before.open":function(){var t=this.app.popup.getStack(),e=t.getName();"link"===e&&this._dropdown(t),"link-create"===e&&this._insertLink(t)}},init:function(){var t=this.opts.craft;this.linkOptions=t.linkOptions,this.elementSiteId=t.elementSiteId},make:function(t){this.app.popup.close(),this.urlToSet=null,Craft.createElementSelectorModal(t.elementType,{storageKey:"ArticleInput.LinkTo."+t.elementType,sources:t.sources,criteria:t.criteria,defaultSiteId:this.elementSiteId,autoFocusSearchBox:!1,onSelect:$.proxy((function(e){if(e.length){var s=e[0];this.urlToSet=s.url+"#"+t.refHandle+":"+s.id+"@"+s.siteId,this.app.link.format()}}),this),closeOtherModals:!1})},_dropdown:function(t){var e=t.getItemsData();for(var s in this.linkOptions){var a={title:(s=this.linkOptions[s]).optionTitle,command:"craft-link.make",params:s},i=this.app.utils.getObjectIndex(e,"unlink");e=this.app.utils.insertToObject(s.elementType,a,e,i)}t.setItemsData(e)},_insertLink:function(t){null!==this.urlToSet&&(t.data.url=this.urlToSet)}}),(()=>{window.articleEditors=[],jQuery((function(e){Garnish.on(Craft.Preview,"open",t),Garnish.on(Craft.LivePreview,"enter",t),Garnish.on(Craft.Preview,"close",t),Garnish.on(Craft.LivePreview,"exit",t)}));var t=function(){articleEditors.forEach((function(t){$("#"+t.$element.nodes[0].id).length>0&&(t.stop(),t.start())}))}})();